# JAM Implementation Guide

## Gray Paper Integration

This guide provides specific implementation instructions based on the [JAM Gray Paper](https://github.com/gavofyork/graypaper) specifications.

## Core Protocol Implementation

### 1. Safrole Consensus Protocol

**Reference**: `graypaper/text/safrole.tex`

#### Key Components to Implement:
- **Ticket Accumulator**: Implement as specified in Section 3.1
- **Ring Commitment**: Follow Section 3.2 for Bandersnatch ring proofs
- **Epoch Transitions**: Implement according to Section 4.1
- **Fallback Mechanism**: Follow Section 4.2 when insufficient tickets

#### Implementation Checklist:
- [ ] Ticket envelope structure matches Gray Paper definition
- [ ] Ring proof validation follows Bandersnatch specification
- [ ] Epoch progression logic implements formal judgments
- [ ] Fallback mechanism triggers correctly
- [ ] State transitions preserve all invariants

### 2. Para Virtual Machine (PVM)

**Reference**: `graypaper/text/pvm.tex`

#### Core PVM Features:
- **Execution Environment**: Implement as specified in Section 2
- **State Management**: Follow Section 3 for state transitions
- **Error Handling**: Use error codes from Section 4
- **Invocation Protocol**: Implement according to Section 5

#### PVM Invocations:
**Reference**: `graypaper/text/pvm_invocations.tex`

- [ ] Core assignment invocations
- [ ] Work package processing
- [ ] State transition invocations
- [ ] Error propagation

### 3. Work Packages and Reports

**Reference**: `graypaper/text/work_packages_and_reports.tex`

#### Implementation Requirements:
- **Work Package Structure**: Follow Section 2.1
- **Report Generation**: Implement Section 3.1
- **Validation Logic**: Use Section 4.1
- **State Updates**: Follow Section 5.1

### 4. Data Availability

**Reference**: `graypaper/text/erasure_coding.tex`

#### Erasure Coding Implementation:
- **Encoding Process**: Follow Section 2.1
- **Decoding Process**: Implement Section 2.2
- **Recovery Threshold**: Use Section 3.1
- **Data Reconstruction**: Follow Section 4.1

### 5. State Management

**Reference**: `graypaper/text/definitions.tex`

#### State Components:
- **Validator Sets**: Implement Section 3.1
- **Core Assignments**: Follow Section 3.2
- **Epoch Data**: Use Section 3.3
- **Accumulator State**: Follow Section 3.4

### 6. Serialization

**Reference**: `graypaper/text/serialization.tex`

#### Serialization Requirements:
- **Binary Format**: Follow Section 2.1
- **Encoding Rules**: Implement Section 2.2
- **Size Constraints**: Use Section 3.1
- **Validation**: Follow Section 4.1

## Mathematical Implementation

### 1. Bandersnatch VRF

**Reference**: `graypaper/text/bandersnatch.tex`

#### Cryptographic Operations:
- **Point Operations**: Implement Section 2.1
- **Scalar Operations**: Follow Section 2.2
- **Ring Proof Generation**: Use Section 3.1
- **Proof Verification**: Follow Section 4.1

### 2. Merklization

**Reference**: `graypaper/text/merklization.tex`

#### Merkle Tree Implementation:
- **Tree Construction**: Follow Section 2.1
- **Proof Generation**: Implement Section 2.2
- **Proof Verification**: Use Section 3.1
- **Root Computation**: Follow Section 4.1

## Testing and Validation

### 1. Test Vector Compliance

**Reference**: `jamtestvectors/` submodule

#### Testing Requirements:
- [ ] All Safrole test vectors pass
- [ ] PVM invocation tests succeed
- [ ] Erasure coding tests validate
- [ ] Serialization tests pass
- [ ] State transition tests succeed

### 2. Formal Verification

**Reference**: `graypaper/text/judgments.tex`

#### Verification Points:
- [ ] State transition judgments are correctly implemented
- [ ] All mathematical proofs are valid
- [ ] Invariants are preserved
- [ ] Error conditions are handled correctly

## Implementation Standards

### 1. Code Organization

```
src/
├── safrole/           # Consensus protocol
│   ├── tickets.ts     # Ticket handling
│   ├── epochs.ts      # Epoch management
│   └── ring-proofs.ts # Bandersnatch proofs
├── pvm/               # Para Virtual Machine
│   ├── execution.ts   # PVM execution
│   ├── state.ts       # State management
│   └── invocations.ts # PVM invocations
├── availability/      # Data availability
│   ├── erasure.ts     # Erasure coding
│   └── recovery.ts    # Data recovery
└── serialization/     # Data serialization
    ├── binary.ts      # Binary format
    └── validation.ts  # Format validation
```

### 2. Documentation Requirements

#### Code Comments:
```typescript
/**
 * Implements Safrole ticket accumulator as specified in Gray Paper Section 3.1
 * Reference: graypaper/text/safrole.tex
 * 
 * @param tickets - Array of ticket envelopes
 * @param maxSize - Maximum accumulator size
 * @returns Updated accumulator state
 */
function updateTicketAccumulator(tickets: TicketEnvelope[], maxSize: number): AccumulatorState {
  // Implementation follows Gray Paper Section 3.1.2
}
```

#### Error Handling:
```typescript
/**
 * Error codes as defined in Gray Paper Section 4.1
 * Reference: graypaper/text/safrole.tex
 */
enum SafroleError {
  BAD_SLOT = 0,           // Section 4.1.1
  UNEXPECTED_TICKET = 1,  // Section 4.1.2
  BAD_TICKET_ORDER = 2,   // Section 4.1.3
  BAD_TICKET_PROOF = 3,   // Section 4.1.4
  BAD_TICKET_ATTEMPT = 4, // Section 4.1.5
  DUPLICATE_TICKET = 6    // Section 4.1.6
}
```

### 3. Testing Standards

#### Unit Tests:
```typescript
describe('Safrole Ticket Accumulator', () => {
  it('should follow Gray Paper Section 3.1.2', () => {
    // Test implementation against Gray Paper specification
  });
  
  it('should handle edge cases from Section 3.1.3', () => {
    // Test edge cases as specified
  });
});
```

#### Integration Tests:
```typescript
describe('PVM Invocations', () => {
  it('should execute according to graypaper/text/pvm_invocations.tex', () => {
    // Test PVM invocation protocol
  });
});
```

## Compliance Verification

### 1. Pre-Implementation Checklist

- [ ] Read relevant Gray Paper sections
- [ ] Understand mathematical foundations
- [ ] Review test vector requirements
- [ ] Plan implementation structure
- [ ] Identify potential challenges

### 2. Implementation Checklist

- [ ] Follow Gray Paper specifications exactly
- [ ] Implement all required components
- [ ] Add comprehensive documentation
- [ ] Include Gray Paper references
- [ ] Handle all error conditions

### 3. Post-Implementation Checklist

- [ ] All test vectors pass
- [ ] Documentation is complete
- [ ] Code review completed
- [ ] Performance is acceptable
- [ ] Security review passed

## Resources

- **Gray Paper**: `graypaper/` submodule
- **Test Vectors**: `jamtestvectors/` submodule
- **Community Docs**: https://docs.jamcha.in/
- **Implementation Examples**: See test vectors for reference implementations

## Enforcement

- All implementations must reference specific Gray Paper sections
- Test failures must be resolved by fixing implementation
- Documentation must cite Gray Paper sources
- Code reviews must verify Gray Paper compliance
- Performance optimizations must preserve protocol semantics

**Remember**: The Gray Paper is the authoritative source. When implementing JAM protocol components, always consult the relevant Gray Paper sections first.
description:
globs:
alwaysApply: false
---
